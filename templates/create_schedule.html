{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-lg-6">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white">
        <h3 class="mb-0"><i class="bi bi-plus-circle-fill"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á OT ‡πÉ‡∏´‡∏°‡πà</h3>
      </div>
      <div class="card-body">
        
        <form id="create-ot-form">
          <div class="mb-3">
            <label for="ot_date" class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OT <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="ot_date" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏•‡∏±‡∏Å) <span class="text-danger">*</span></label>
            <div class="p-3 border rounded" style="max-height: 400px; overflow-y: auto;">
              {% for user in users %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="user_ids" value="{{ user.id }}" id="user_{{ user.id }}">
                <label class="form-check-label" for="user_{{ user.id }}">
                  {{ user.full_name }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary w-100 btn-lg">
            <i class="bi bi-send-fill"></i>
            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á OT ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á LINE
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm border-0" id="result-card" style="display: none;">
      <div class="card-body p-4 text-center">
        
        <div id="loading-spinner" class.="text-center p-5" style="display: none;">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á LINE...</p>
        </div>

        <div id="result-content">
          </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  document.getElementById('create-ot-form').addEventListener('submit', async function(event) {
    event.preventDefault(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£ submit form ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥

    const otDate = document.getElementById('ot_date').value;
    const selectedCheckboxes = document.querySelectorAll('input[name="user_ids"]:checked');
    const userIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const resultCard = document.getElementById('result-card');
    const resultContent = document.getElementById('result-content');
    const loadingSpinner = document.getElementById('loading-spinner');
    
    resultCard.style.display = 'block';
    resultContent.innerHTML = '';
    loadingSpinner.style.display = 'block';

    if (!otDate || userIds.length === 0) {
      loadingSpinner.style.display = 'none';
      resultContent.innerHTML = `
        <h3 class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p class="fs-5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô</p>
      `;
      return;
    }

    const data = {
      date: otDate,
      user_ids: userIds
    };

    try {
      const response = await fetch("{{ url_for('create_schedule') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();
      loadingSpinner.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô loading

      if (response.ok) {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ---
        // (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô Screenshot ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        let linksHtml = '';
        if (result.links && result.links.length > 0) {
          linksHtml = '<h5 class="mt-4 text-start">üö® ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Admin ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏á):</h5>';
          linksHtml += '<ul class="list-group text-start">';
          result.links.forEach(item => {
            linksHtml += `
              <li class="list-group-item">
                <strong>${item.name}</strong><br>
                <input type="text" class="form-control form-control-sm mt-1" value="${item.link}" readonly onclick="this.select()">
              </li>
            `;
          });
          linksHtml += '</ul>';
        } else {
          linksHtml = '<p class="text-muted">(‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á LINE ‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</p>';
        }

        resultContent.innerHTML = `
          <h3 class="text-success"><i class="bi bi-check-circle-fill"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á OT ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
          <p class="fs-5">(‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° LINE ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</p>
          ${linksHtml}
          <hr>
          <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary mt-3">
            <i class="bi bi-bar-chart-fill"></i>
            ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          </a>
        `;
      } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ Error ‡∏à‡∏≤‡∏Å Backend ---
        resultContent.innerHTML = `
          <h3 class="text-danger"><i class="bi bi-x-circle-fill"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
          <p class="fs-5 text-muted">${result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}</p>
        `;
      }

    } catch (error) {
      // --- ‡∏Å‡∏£‡∏ì‡∏µ Network Error ---
      loadingSpinner.style.display = 'none';
      resultContent.innerHTML = `
        <h3 class="text-danger"><i class="bi bi-wifi-off"></i> ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p class="fs-5 text-muted">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Server ‡πÑ‡∏î‡πâ: ${error.message}</p>
      `;
    }
  });
</script>
{% endblock %}