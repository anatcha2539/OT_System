<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการผู้ใช้งาน</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2 { color: #333; }
        nav { margin-bottom: 2em; }
        nav a { margin-right: 1em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .form-container { margin-top: 2em; padding: 1em; border: 1px solid #ccc; border-radius: 5px; }
        .form-container input { width: 200px; margin-right: 10px; }
        .action-btn { margin-right: 5px; }
    </style>
</head>
<body>
    <h1>ระบบจัดการ OT</h1>
    <nav>
        <a href="{{ url_for('admin_dashboard') }}">Dashboard</a> |
        <a href="{{ url_for('admin_create_page') }}">สร้างตาราง OT</a> |
        <strong>จัดการผู้ใช้งาน</strong>
    </nav>

    <div class="form-container">
        <h2>เพิ่มผู้ใช้งานใหม่</h2>
        <form action="{{ url_for('add_user') }}" method="POST">
            <label for="username">Username (ตัวย่อ):</label>
            <input type="text" id="username" name="username" required>
            
            <label for="full_name">ชื่อ-นามสกุล (เต็ม):</label>
            <input type="text" id="full_name" name="full_name" required>
            
            <button type="submit">เพิ่มผู้ใช้งาน</button>
        </form>
    </div>

    <h2>รายชื่อผู้ใช้งานทั้งหมด ({{ users|length }} คน)</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>ชื่อ-นามสกุล</th>
                <th style="width: 150px;">การจัดการ</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.full_name }}</td>
                <td>
                    <button class="action-btn" onclick="editUser({{ user.id }}, '{{ user.full_name }}')">แก้ไข</button>
                    
                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="action-btn" onclick="return confirm('คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ {{ user.full_name }}?')">ลบ</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        // ฟังก์ชันสำหรับปุ่มแก้ไข
        function editUser(userId, currentName) {
            const newName = prompt("กรอก ชื่อ-นามสกุล ใหม่สำหรับ:", currentName);
            
            if (newName && newName.trim() !== "") {
                fetch(`/admin/edit-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ full_name: newName.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "success") {
                        window.location.reload(); // รีเฟรชหน้า
                    } else {
                        alert("เกิดข้อผิดพลาด: " + data.error);
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
                });
            }
        }
    </script>
</body>
</html>