<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการผู้ใช้งาน</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        h1, h2 { color: #333; }
        nav { margin-bottom: 2em; }
        nav a { margin-right: 1em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        .form-container { margin-top: 2em; padding: 1em; border: 1px solid #ccc; border-radius: 5px; }
        .form-container input { width: 200px; margin-right: 10px; margin-bottom: 10px; }
        .action-btn { margin-right: 5px; }
        
        /* (ใหม่) สไตล์สำหรับช่อง LINE ID */
        th:nth-child(3), td:nth-child(3) { width: 35%; }
        td:nth-child(3) input { width: 95%; } /* ให้ input ในตารางเต็มช่อง */
    </style>
</head>
<body>
    <h1>ระบบจัดการ OT</h1>
    <nav>
        <a href="{{ url_for('admin_dashboard') }}">Dashboard</a> |
        <a href="{{ url_for('admin_create_page') }}">สร้างตาราง OT</a> |
        <strong>จัดการผู้ใช้งาน</strong>
    </nav>

    <div class="form-container">
        <h2>เพิ่มผู้ใช้งานใหม่</h2>
        <form action="{{ url_for('add_user') }}" method="POST">
            <label for="username">Username (ตัวย่อ):</label>
            <input type="text" id="username" name="username" required>
            
            <label for="full_name">ชื่อ-นามสกุล (เต็ม):</label>
            <input type="text" id="full_name" name="full_name" required>

            <label for="line_user_id">LINE User ID (ไม่บังคับ):</label>
            <input type="text" id="line_user_id" name="line_user_id" placeholder="U123456789...">
            <button type="submit">เพิ่มผู้ใช้งาน</button>
        </form>
        <small>วิธีหา LINE User ID: ให้พนักงานแอดบอทของคุณเป็นเพื่อน แล้วส่งข้อความอะไรก็ได้ บอทของคุณต้องตั้งค่า "Webhook" เพื่อรับ Event และดึง `source.userId` (ส่วนนี้ต้องเขียนโค้ดเพิ่มที่ฝั่งบอท)</small>
    </div>

    <h2>รายชื่อผู้ใช้งานทั้งหมด ({{ users|length }} คน)</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>LINE User ID</th>
                <th>ชื่อ-นามสกุล</th>
                <th style="width: 150px;">การจัดการ</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr id="user-row-{{ user.id }}">
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>
                    <input type="text" 
                           id="line-id-{{ user.id }}" 
                           value="{{ user.line_user_id or '' }}" 
                           placeholder="(ว่าง)">
                </td>
                <td>
                     <input type="text" 
                            id="full-name-{{ user.id }}" 
                            value="{{ user.full_name }}" 
                            required>
                </td>
                <td>
                    <button class="action-btn" onclick="editUser({{ user.id }})">บันทึก</button>
                    
                    <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="action-btn" onclick="return confirm('คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ {{ user.full_name }}?')">ลบ</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function editUser(userId) {
            const newName = document.getElementById(`full-name-${userId}`).value;
            const newLineId = document.getElementById(`line-id-${userId}`).value;

            if (!newName || newName.trim() === "") {
                alert("กรุณากรอก ชื่อ-นามสกุล");
                return;
            }

            document.getElementById(`user-row-${userId}`).style.backgroundColor = '#fffbe6';

            fetch(`/admin/edit-user/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    full_name: newName.trim(),
                    line_user_id: newLineId.trim() 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "success") {
                    document.getElementById(`user-row-${userId}`).style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                         document.getElementById(`user-row-${userId}`).style.backgroundColor = '';
                    }, 2000);
                } else {
                    alert("เกิดข้อผิดพลาด: " + data.error);
                    document.getElementById(`user-row-${userId}`).style.backgroundColor = '#f8d7da';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
                document.getElementById(`user-row-${userId}`).style.backgroundColor = '#f8d7da';
            });
        }
    </script>
</body>
</html>